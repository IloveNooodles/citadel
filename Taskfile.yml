# https://taskfile.dev

version: "3"

tasks:
  check-talos-node:
    dir: ./terraform
    cmds:
      - terraform init
      - terraform plan
  setup-talos-node:
    dir: ./terraform
    cmds:
      - terraform init
      - terraform apply -auto-approve
  gen-talos-config:
    env:
      TALOSCONFIG: "_out/talosconfig"
      CONTROL_PLANE_IP: 192.168.1.144
      WORKER_IP: 192.168.1.117
    cmds:
      - talosctl gen config talos-proxmox-cluster https://$CONTROL_PLANE_IP:6443 --output-dir _out --install-image factory.talos.dev/installer/ce4c980550dd2ab1b17bbf2b08801c7eb59418eafe8f279833297925d67c7515:v1.11.0
      - talosctl --talosconfig $TALOSCONFIG apply-config --insecure --nodes $CONTROL_PLANE_IP --file _out/controlplane.yaml
      - talosctl --talosconfig $TALOSCONFIG apply-config --insecure --nodes $WORKER_IP --file _out/worker.yaml
      - talosctl --talosconfig $TALOSCONFIG config endpoint $CONTROL_PLANE_IP
      - talosctl --talosconfig $TALOSCONFIG config node $CONTROL_PLANE_IP
      - talosctl --talosconfig $TALOSCONFIG config info
  boostrap-talos:
    env:
      TALOSCONFIG: "_out/talosconfig"
    cmds:
      - talosctl --talosconfig $TALOSCONFIG bootstrap
  add-talos-kubeinfo:
    desc: This will backup your old kubeconfig that lives in the `~/.kube/config` to the `~/.kube/config.bak`
    env:
      TALOSCONFIG: "_out/talosconfig"
    cmds:
      - talosctl --talosconfig $TALOSCONFIG kubeconfig ~/.kube/talos-kubeconfig.yml
  setup-argocd:
    desc: This is to install argocd in the kubernetes cluster.
    summary: See https://argo-cd.readthedocs.io/en/stable/getting_started. The server is accessible in the $PORT and Password available on the `pass` file
    cmds:
      - |
        kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
        kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
        kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "ClusterIP"}}'
  get-argocd-password:
    cmds:
      - kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath="{.data.password}" | base64 --decode
  port-forward-argocd:
    cmds:
      - kubectl port-forward svc/argocd-server -n argocd 8080:443
